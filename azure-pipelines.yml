# Azure DevOps Pipeline para ejecutar el backend Python y publicar extensión VS Code
trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: OPENAI_API_KEY
    value: $(OPENAI_API_KEY)
  # Asegúrate que esta variable esté definida como secreta en el entorno o en Variable Group
  - name: VSCE_TOKEN
    value: $(VSCE_TOKEN)

steps:
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.11'

- script: |
    echo "OPENAI-API-KEY: $OPENAI_API_KEY"
  displayName: 'Debug variables'
  shell: bash

- script: |
    python --version
    pip install -r agent-backend/requirements.txt
    python agent-backend/cli.py
  displayName: 'Instala dependencias y ejecuta backend'
  shell: bash

- script: |
    echo "Instalando vsce y dependencias..."
    npm install -g @vscode/vsce
    npm install
    npm run compile
    echo "Empaquetando extensión..."
    vsce package
    echo "Publicando extensión VS Code..."
    vsce publish -p "$VSCE_TOKEN"
  displayName: 'Compila, empaqueta y publica extensión VS Code'
  env:
    VSCE_TOKEN: $(VSCE_TOKEN)
  shell: bash
