trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: OPENAI_API_KEY
    value: $(OPENAI_API_KEY)
  - name: VSCE_TOKEN
    value: $(VSCE_TOKEN)

steps:
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.11'

- task: Bash@3
  displayName: 'Debug variables'
  inputs:
    targetType: 'inline'
    script: |
      echo "OPENAI-API-KEY: $OPENAI_API_KEY"

- task: Bash@3
  displayName: 'Instala dependencias y ejecuta backend'
  inputs:
    targetType: 'inline'
    script: |
      python --version
      pip install -r agent-backend/requirements.txt
      python agent-backend/cli.py

- task: Bash@3
  displayName: 'Compila, empaqueta y publica extensión VS Code'
  inputs:
    targetType: 'inline'
    script: |
      echo "Instalando vsce..."
      npm install -g @vscode/vsce
      npm install
      npm run compile
      echo "Empaquetando extensión..."
      vsce package
      echo "Publicando extensión..."
      vsce publish -p "$VSCE_TOKEN"
  env:
    VSCE_TOKEN: $(VSCE_TOKEN)